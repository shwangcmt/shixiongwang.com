---
/**
 * Custom theme selector with styled dropdown (not native OS select).
 * Uses original Starlight icons for consistent appearance.
 * Icons switch based on selected theme.
 */
import { Icon } from "@astrojs/starlight/components";
---

<starlight-theme-select>
    <div class="theme-select-wrapper">
        <button
            type="button"
            class="theme-toggle"
            aria-label="Select theme"
            aria-expanded="false"
        >
            <!-- Sun icon (Light theme) -->
            <Icon name="sun" class="icon sun" />
            <!-- Moon icon (Dark theme) -->
            <Icon name="moon" class="icon moon" />
            <!-- Laptop icon (Auto theme) -->
            <Icon name="laptop" class="icon laptop" />
            <span class="theme-label">Auto</span>
            <Icon name="down-caret" class="caret" />
        </button>
        <div class="theme-dropdown" role="listbox" aria-label="Theme options">
            <button
                type="button"
                class="theme-option"
                data-theme="dark"
                role="option"
            >
                <Icon name="moon" />
                <span>Dark</span>
            </button>
            <button
                type="button"
                class="theme-option"
                data-theme="light"
                role="option"
            >
                <Icon name="sun" />
                <span>Light</span>
            </button>
            <button
                type="button"
                class="theme-option"
                data-theme="auto"
                role="option"
            >
                <Icon name="laptop" />
                <span>Auto</span>
            </button>
        </div>
    </div>
</starlight-theme-select>

{/* Inlined to avoid FOUC. Uses global scope from `ThemeProvider.astro` */}
<script is:inline>
    StarlightThemeProvider.updatePickers();
</script>

<script>
    // Declare the global StarlightThemeProvider from Starlight's ThemeProvider.astro
    declare const StarlightThemeProvider: {
        updatePickers(theme?: string): void;
    };

    type Theme = "auto" | "dark" | "light";

    const storageKey = "starlight-theme";
    const themeLabels: Record<Theme, string> = {
        dark: "Dark",
        light: "Light",
        auto: "Auto",
    };

    const parseTheme = (theme: unknown): Theme =>
        theme === "auto" || theme === "dark" || theme === "light"
            ? theme
            : "auto";

    const loadTheme = (): Theme =>
        parseTheme(
            typeof localStorage !== "undefined" &&
                localStorage.getItem(storageKey)
        );

    function storeTheme(theme: Theme): void {
        if (typeof localStorage !== "undefined") {
            localStorage.setItem(
                storageKey,
                theme === "light" || theme === "dark" ? theme : ""
            );
        }
    }

    const getPreferredColorScheme = (): Theme =>
        matchMedia("(prefers-color-scheme: light)").matches ? "light" : "dark";

    function onThemeChange(theme: Theme): void {
        StarlightThemeProvider.updatePickers(theme);
        document.documentElement.dataset.theme =
            theme === "auto" ? getPreferredColorScheme() : theme;
        storeTheme(theme);

        // Update browser theme-color meta tag (Safari fix included)
        const color =
            (theme === "auto" ? getPreferredColorScheme() : theme) === "dark"
                ? "#100f0f" // Flexoki Dark (Body Background)
                : "#fffcf0"; // Flexoki Light (Body Background)

        // 1. Remove Any Existing Tag (Force Repaint)
        // Use querySelectorAll to remove potential duplicates (e.g. static tags from astro.config)
        document
            .querySelectorAll('meta[name="theme-color"]')
            .forEach((el) => el.remove());

        // 2. Create Fresh Tag
        const newMeta = document.createElement("meta");
        newMeta.name = "theme-color";
        newMeta.content = color;
        document.head.appendChild(newMeta);

        // 3. Force Safari Repaint (Dummy Tag Trick)
        try {
            const dummy = document.createElement("meta");
            dummy.name = "safari-force-repaint";
            dummy.content = Date.now().toString();
            document.head.appendChild(dummy);
            setTimeout(() => dummy.remove(), 10);
        } catch (e) {}

        // Update all theme selects
        document.querySelectorAll("starlight-theme-select").forEach((el) => {
            el.setAttribute("data-theme", theme);
            // Update the label text
            const label = el.querySelector(".theme-label");
            if (label) label.textContent = themeLabels[theme];
            el.querySelector(".theme-toggle")?.setAttribute(
                "aria-expanded",
                "false"
            );
            el.querySelector(".theme-dropdown")?.classList.remove("open");
        });
    }

    matchMedia(`(prefers-color-scheme: light)`).addEventListener(
        "change",
        () => {
            if (loadTheme() === "auto") onThemeChange("auto");
        }
    );

    class StarlightThemeSelect extends HTMLElement {
        constructor() {
            super();
            const currentTheme = loadTheme();
            onThemeChange(currentTheme);
            this.setAttribute("data-theme", currentTheme);

            const toggle = this.querySelector(".theme-toggle");
            const dropdown = this.querySelector(".theme-dropdown");
            const options = this.querySelectorAll(".theme-option");

            toggle?.addEventListener("click", (e) => {
                e.stopPropagation();
                const isOpen = dropdown?.classList.toggle("open");
                toggle.setAttribute("aria-expanded", isOpen ? "true" : "false");
            });

            options.forEach((option) => {
                option.addEventListener("click", () => {
                    const theme = option.getAttribute("data-theme") as Theme;
                    onThemeChange(parseTheme(theme));
                });
            });

            document.addEventListener("click", () => {
                dropdown?.classList.remove("open");
                toggle?.setAttribute("aria-expanded", "false");
            });

            dropdown?.addEventListener("click", (e) => e.stopPropagation());
        }
    }

    customElements.define("starlight-theme-select", StarlightThemeSelect);
</script>

<style>
    .theme-select-wrapper {
        position: relative;
        display: inline-block;
    }

    .theme-toggle {
        display: flex;
        align-items: center;
        gap: 0.125rem;
        padding: 0.625rem 0.25rem;
        background: transparent;
        border: none;
        color: var(
            --sl-color-gray-3
        ); /* Match GitHub icon normal state (Dimmed) */
        cursor: pointer;
        transition: color 0.15s ease;
        font-size: var(--sl-text-sm);
    }

    .theme-toggle:hover {
        color: var(
            --sl-color-text-accent
        ); /* Match GitHub icon hover state (Bright) */
    }

    /* Hide all theme icons by default */
    .theme-toggle .icon {
        width: 1rem;
        height: 1rem;
        display: none;
    }

    /* Show icon based on current theme */
    starlight-theme-select[data-theme="light"] .theme-toggle .sun,
    starlight-theme-select[data-theme="dark"] .theme-toggle .moon,
    starlight-theme-select[data-theme="auto"] .theme-toggle .laptop,
    starlight-theme-select:not([data-theme]) .theme-toggle .laptop {
        display: block;
    }

    .theme-label {
        margin-inline: 0.25rem;
        width: 2.25em;
        display: inline-block;
    }

    .caret {
        width: 1.25rem;
        height: 1.25rem;
        transition: transform 0.15s ease;
    }

    .theme-toggle[aria-expanded="true"] .caret {
        transform: rotate(180deg);
    }

    .theme-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        min-width: 100%;
        margin-top: 0.25rem;
        padding: 0.25rem;
        background: var(--sl-color-bg-nav);
        border-radius: 0.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        opacity: 0;
        visibility: hidden;
        transform: translateY(-4px);
        transition: opacity 0.15s ease, transform 0.15s ease, visibility 0.15s;
        z-index: 100;
    }

    .theme-dropdown.open {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .theme-option {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        width: 100%;
        padding: 0.5rem 0.75rem;
        background: transparent;
        border: none;
        color: var(--sl-color-gray-3); /* Light Mode Normal */
        font-size: var(--sl-text-sm);
        text-align: left;
        cursor: pointer;
        border-radius: 0.25rem;
        transition: background-color 0.15s ease, color 0.15s ease;
        white-space: nowrap;
    }

    .theme-option svg {
        flex-shrink: 0;
        width: 1rem;
        height: 1rem;
    }

    .theme-option:hover {
        background: var(--sl-color-gray-6);
        color: var(--sl-color-text-accent); /* Hover */
    }

    /* Highlight current selection - matches sidebar style */
    starlight-theme-select[data-theme="light"]
        .theme-option[data-theme="light"],
    starlight-theme-select[data-theme="dark"] .theme-option[data-theme="dark"],
    starlight-theme-select[data-theme="auto"] .theme-option[data-theme="auto"] {
        background: var(--sl-color-accent-low);
        color: var(--sl-color-text-accent);
        font-weight: 600;
    }

    /* =========================================
       DARK MODE OVERRIDES
       ========================================= */

    /* 1. Theme Toggle: Force Bright Accent (Match GitHub Icon) */
    :global([data-theme="dark"]) .theme-toggle {
        color: var(--sl-color-text-accent);
    }

    /* 1b. Mobile Menu Override: Revert to Gray (Match Mobile GitHub Icon) */
    :global([data-theme="dark"] .mobile-preferences) .theme-toggle {
        color: var(--sl-color-gray-3);
    }

    /* 2. Dropdown Menu: Swap Selected & Hover Backgrounds */
    /* Selected Item: Use Gray-6 (Subtle) instead of Accent-Low */
    :global([data-theme="dark"])
        starlight-theme-select[data-theme="light"]
        .theme-option[data-theme="light"],
    :global([data-theme="dark"])
        starlight-theme-select[data-theme="dark"]
        .theme-option[data-theme="dark"],
    :global([data-theme="dark"])
        starlight-theme-select[data-theme="auto"]
        .theme-option[data-theme="auto"] {
        background: var(--sl-color-gray-6);
        color: var(--sl-color-text-accent);
    }

    /* Hover Item: Use Accent-Low (Prominent) instead of Gray-6 */
    :global([data-theme="dark"]) .theme-option:hover {
        background: var(--sl-color-accent-low);
        color: var(--sl-color-text-accent);
    }
</style>
